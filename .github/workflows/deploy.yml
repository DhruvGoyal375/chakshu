name: Build, Push Docker Images & Deploy with HTTPS on Azure ACI + Front Door

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Docker & Docker-Compose
      run: |
        curl -fsSL https://get.docker.com -o get-docker.sh
        sudo sh get-docker.sh
        docker --version
        docker compose version

    - name: Create .env file
      run: |
        echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env
        echo "DB_USER=${{ secrets.DB_USER }}" >> .env
        echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
        echo "DB_HOST=${{ secrets.DB_HOST }}" >> .env
        echo "DB_PORT=${{ secrets.DB_PORT }}" >> .env
        echo "DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}" >> .env

    - name: Build Docker Images
      run: |
        docker compose build

    - name: Log in to Docker Hub
      run: |
        echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Tag and Push Docker Images
      run: |
        USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"
        
        # Tag images
        docker tag chakshu-chakshu:latest $USERNAME/chakshu-chakshu:latest
        docker tag chakshu-node:latest $USERNAME/chakshu-node:latest

        # Push images to Docker Hub
        docker push $USERNAME/chakshu-chakshu:latest
        docker push $USERNAME/chakshu-node:latest

    # ✅ Deploy to Azure ACI (Full Resources)
    - name: Deploy to Azure ACI
      run: |
        az login --service-principal \
          --username "${{ secrets.AZURE_CLIENT_ID }}" \
          --password "${{ secrets.AZURE_CLIENT_SECRET }}" \
          --tenant "${{ secrets.AZURE_TENANT_ID }}"

        CONTAINER_NAME="chakshu-container"
        RESOURCE_GROUP="${{ secrets.AZURE_RESOURCE_GROUP }}"

        # Delete existing container if it exists
        if az container show --resource-group "$RESOURCE_GROUP" --name "$CONTAINER_NAME" &> /dev/null; then
          echo "Container $CONTAINER_NAME exists. Deleting..."
          az container delete --resource-group "$RESOURCE_GROUP" --name "$CONTAINER_NAME" --yes
        else
          echo "No existing container found."
        fi

        # Deploy with Full Resources (4 CPU, 16 GB RAM)
        az container create \
          --resource-group "$RESOURCE_GROUP" \
          --name "$CONTAINER_NAME" \
          --image "${{ secrets.DOCKERHUB_USERNAME }}/chakshu-chakshu:latest" \
          --cpu 4 --memory 16 \
          --dns-name-label "chakshu-demo" \
          --ports 8000 80 \
          --os-type Linux \
          --restart-policy Always \
          --registry-login-server "index.docker.io" \
          --registry-username "${{ secrets.DOCKERHUB_USERNAME }}" \
          --registry-password "${{ secrets.DOCKERHUB_PASSWORD }}" \
          --environment-variables \
            DB_NAME="${{ secrets.DB_NAME }}" \
            DB_USER="${{ secrets.DB_USER }}" \
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            DB_HOST="${{ secrets.DB_HOST }}" \
            DB_PORT="${{ secrets.DB_PORT }}" \
            DJANGO_SECRET_KEY="${{ secrets.DJANGO_SECRET_KEY }}"

    # ✅ Configure Full-Fledged Azure Front Door (Not Free Tier)
    - name: Configure Azure Front Door
      run: |
        FRONTDOOR_NAME="chakshu-frontdoor"
        RESOURCE_GROUP="${{ secrets.AZURE_RESOURCE_GROUP }}"
        CONTAINER_FQDN="chakshu-demo.${{ secrets.AZURE_REGION }}.azurecontainer.io"

        # Check if Front Door exists
        if az afd profile show --resource-group "$RESOURCE_GROUP" --profile-name "$FRONTDOOR_NAME" &> /dev/null; then
          echo "Azure Front Door $FRONTDOOR_NAME already exists. Skipping creation."
        else
          echo "Creating Azure Front Door..."

          az afd profile create \
            --resource-group "$RESOURCE_GROUP" \
            --profile-name "$FRONTDOOR_NAME" \
            --sku Premium_AzureFrontDoor

          # ✅ Create Frontend Endpoint
          az afd endpoint create \
            --resource-group "$RESOURCE_GROUP" \
            --profile-name "$FRONTDOOR_NAME" \
            --endpoint-name "chakshu-frontend" \
            --enabled-state "Enabled"

          # ✅ Create Backend Pool
          az afd origin-group create \
            --resource-group "$RESOURCE_GROUP" \
            --profile-name "$FRONTDOOR_NAME" \
            --origin-group-name "chakshu-backend-pool" \
            --probe-request-type "GET" \
            --probe-protocol "Http" \
            --probe-interval-in-seconds 30 \
            --probe-path "/"

          az afd origin create \
            --resource-group "$RESOURCE_GROUP" \
            --profile-name "$FRONTDOOR_NAME" \
            --origin-group-name "chakshu-backend-pool" \
            --origin-name "chakshu-origin" \
            --host-name "$CONTAINER_FQDN" \
            --http-port 80 \
            --https-port 443 \
            --priority 1 \
            --weight 100

          # ✅ Add Routing Rule
          az afd route create \
            --resource-group "$RESOURCE_GROUP" \
            --profile-name "$FRONTDOOR_NAME" \
            --endpoint-name "chakshu-frontend" \
            --route-name "chakshu-route" \
            --origin-group-name "chakshu-backend-pool" \
            --forwarding-protocol "MatchRequest" \
            --supported-protocols "Http Https" \
            --patterns-to-match "/*"

          echo "Azure Front Door created successfully."

    - name: Cleanup Docker Cache
      run: |
        docker system prune -af
